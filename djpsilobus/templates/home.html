{% extends "base.html" %}
{% block extra_javascript %}
<script src="//www.carthage.edu/static/vendor/dashboard/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="//www.carthage.edu/static/vendor/dashboard/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="https://malsup.github.io/min/jquery.blockUI.min.js"
    type="text/javascript"></script>
<script type="text/javascript">
$(function(){
  var table = $('.courses-data').dataTable({
    "bPaginate": false
  });
  $(".required > input").addClass("required");
  $(".required > select").addClass("required");
  $(".required > textarea").addClass("required");
  $(".warning > input").addClass("error");
  $(".warning > select").addClass("error");
  $(".warning > textarea").addClass("error");
  $(".required > ul").parent().parent().find('h3').addClass("required");
  $('#olvidado').click(function(e) {
    e.preventDefault();
    $('div#form-olvidado').toggle('500');
  });
  $('#acceso').click(function(e) {
    e.preventDefault();
    $('div#form-olvidado').toggle('500');
  });
  $('select[name^="dept_faculty_"]').change(function(){
    $('#faculty-courses').submit();
  });
  $('#toggle-departments').click(function(){
    $(this).text(function(i,old){
      return old=='Show Departments' ? 'Hide Departments' : 'Show Departments';
    });
  });
  // flag syllabi for upload.
  // cgi on the backend does not include empty file fields in []
  $("#courses").on('change', ".syllabi", function() {
    $(this).next(':hidden').val("True");
  });
  $('.section').each(function(){
    var $dis = $(this);
    var $html = $dis.html();
    var $faculty = $dis.attr("data-faculty");
    var $name = $dis.attr("data-fullname").substring(1);
    var $phile = $dis.attr("data-phile") + ".pdf";
    $dis.html('<i class="fa fa-cog fa-spin fa-2x fa-fw"></i>');
    $.ajax({
      type: "POST",
      url: "{% url 'dspace_file_search' %}",
      data: {"phile":$phile,"name":$name},
      cache: false,
      success: function(data) {
        if (data) {
          if ($faculty) {
            $dis.html($html);
            $dis.children('i.fa-fw').replaceWith(data);
          } else {
            $dis.html(data);
          }
        } else {
          $dis.html($html);
        }
      },
      error: function(data) {
        $dis.html(
          '<i class="fa fa-times red" aria-hidden="true" title="API error"></i>'
        );
      }
    });
  });
  $("#syllabus-upload").submit(function() {
    var $status = true;
    $('input[type="file"]').each(function() {
      var $ext = $(this).val().split('.').pop().toLowerCase();
      if($ext && $ext != "pdf") {
        $status = false;
        return;
      }
    });
    if ($status) {
      $("#syllabus-upload").children('input[type=submit]').attr('disabled', 'disabled');
      //alert('ftw!');
      return true;
      //return false;
    } else {
      $.growlUI('Error', "Files must be in PDF format");
      return false;
    }
  });
});
</script>
{% endblock extra_javascript %}
{% block extra_style %}
    {{block.super}}
    <style type="text/css">
        td, select, input, p {font-size:.9em;}
        select, input {margin-bottom:5px;}
        fieldset {
            border: 1px solid silver;
            margin: 5px 2px;
            padding: .35em .625em .75em;
        }
        legend {
            display: block;
            padding: 2px 10px !important;
            border: 1px solid #003c4b;
            border-radius: 10px;
            background-color: #6ba2b8;
            padding: 0;
            margin-bottom: 0;
            width:200px;
            color: #efefef;
            font-size:.9em;
            font-weight:bold;
        }
        label {margin-bottom:0;}
        #toggle-departments {width:150px;}
        #notice {
            position:absolute; top:175px; left:300px; background-color:#880000;
            border:3px solid white; opacity: .80; filter:Alpha(Opacity=80);
            display:none; color:white; padding:20px; width:300px; z-index:1000;
        }
        .deptHead {width:420px;float:left;margin-right:20px;}
        .section {text-align:center;}
        .red {color:#800;}
        .green {color:#080;}
        .grey {color:#cacaca;}
        .white {color:#fff;}
        .fa-file-pdf-o {font-weight:900; margin-left: 15px; }
        .fa-fw { width: 1em; margin-left: 15px;}
        div.growlUI { position:relative;margin-top:60px; }
        div.growlUI:before { color:red; font-size: 4em;position: absolute; font-family: 'FontAwesome'; top: 0; left: 10px; content: "\f05e"; }
        div.growlUI h1, div.growlUI h2 {
        color: white; padding: 5px 5px 5px 75px; text-align: left;font-size:2em;}
        div.growlUI h2 { font-size:1.4em;}
    </style>
{% endblock extra_style %}
{% block content %}
<div class="row">
    <div class="col-lg-12">
      <h2 title="{{user.id}}">
        {% if depts %}
          You may view the following departments
          <button id="toggle-departments" aria-expanded="true" type="button"
            data-toggle="collapse" data-target="#departments"
            class="btn btn-success collapsed">
            Hide Departments
          </button>
        {% else %}
          Greetings, {{user.first_name}} {{user.last_name}}
        {% endif %}
      </h2>
      {% if phile %}
        {% if phile == "error" %}
        <div class="alert alert-danger col-lg-6">
          <strong>Error</strong>:
          There was a problem uploading the file. Please try again.
        </div>
        {% else %}
        <div class="alert alert-success col-lg-6">
          <strong>Success</strong>:
          The file was uploaded successfully.
        </div>
        {% endif %}
      {% endif %}
    </div>
    <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
{% if depts %}
<div class="row collapse in" id="departments">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-body">
          <form action="{% url 'home' %}" method="post"
            name="faculty-courses"
            id="faculty-courses">
            {% csrf_token %}
            {% for d in depts %}
              <fieldset class="deptHead">
                <legend>{{d.dept.txt}}</legend>
                <div class="form-row">
                  <label for="dept_faculty_{{d.dept.dept}}">
                    View all courses for:
                  </label>
                  <select name="dept_faculty_{{d.dept.dept}}">
                    <option value="">(Select Faculty)</option>
                    {% for f in d.faculty %}
                      <option value="{{f.id}}">
                        {{f.lastname}}, {{f.firstname}}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-row">
                  <a href="{% url 'home_dept' d.dept.dept %}">
                    View all courses {{d.dept.txt}}
                  </a>
                </div>
              </fieldset>
            {% endfor %}
          </form>
      </div>
      <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
  </div>
  <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
{% endif %}
{% if courses %}
<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-body">
        <h2>
          {% if department %}
            {{department}} Syllabi:
          {% else %}
            {% if not department and fid == user.id %}
              My Syllabi:
            {% else %}
              {{faculty_name}}'s Syllabi:
            {% endif %}
          {% endif %}
          {{sess}} {{year}}
        </h2>
        <div class="table-responsive">
          <form action="{% url 'home' %}" method="post" id="syllabus-upload"
            enctype="multipart/form-data">
            {% csrf_token %}
            <table class="table table-striped table-bordered table-hover
              dataTable display courses-data" id="courses">
              <thead>
                <tr>
                  <th style="text-align:center;">Course #</th>
                  <th style="text-align:center;">Course Title</th>
                  <th style="text-align:center;">Secion Number</th>
                  <th style="text-align:center;">Instructor</th>
                  <th style="text-align:center;">Syllabus</th>
                </tr>
              </thead>
              <tbody>
                {% include "syllabi_table.inc.html" %}
              </tbody>
              <tfoot>
                <tr>
                  <th style="text-align:center;">Course #</th>
                  <th style="text-align:center;">Course Title</th>
                  <th style="text-align:center;">Secion Number</th>
                  <th style="text-align:center;">Instructor</th>
                  <th style="text-align:center;">Syllabus</th>
                </tr>
              </tfoot>
            </table>
          </form>
        </div>
      <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
  </div>
  <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
{% else %}
    <p class="clear">There are no course records.</p>
{% endif %}
{% endblock content %}
